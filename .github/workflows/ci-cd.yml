name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  security-events: write
  packages: read

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('output/ci_artifacts/requirements.txt', 'output/ci_artifacts/requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r output/ci_artifacts/requirements.txt
          pip install -r output/ci_artifacts/requirements-dev.txt

      - name: Run tests with pytest
        run: |
          python -m pytest tests/ --cov=nodupe --cov-report=term-missing --cov-report=xml:coverage.xml --cov-fail-under=80 -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('output/ci_artifacts/requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r output/ci_artifacts/requirements-dev.txt

      - name: Run pylint
        run: |
          pylint nodupe/ --disable=all --enable=missing-docstring,invalid-name,missing-module-docstring,missing-class-docstring,missing-function-docstring

      - name: Run markdownlint
        run: |
          npx markdownlint "**/*.md" --ignore node_modules

  docs:
    name: Check Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('output/ci_artifacts/requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r output/ci_artifacts/requirements-dev.txt

      - name: Check docstrings
        run: |
          python -c "
          import ast
          import os

          def check_docstrings(file_path):
              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()

              try:
                  tree = ast.parse(content)

                  for node in ast.walk(tree):
                      if isinstance(node, ast.FunctionDef):
                          if not ast.get_docstring(node):
                              print(f'Missing docstring in function: {node.name} in {file_path}')
                      elif isinstance(node, ast.ClassDef):
                          if not ast.get_docstring(node):
                              print(f'Missing docstring in class: {node.name} in {file_path}')
                      elif isinstance(node, ast.Module):
                          if not ast.get_docstring(node):
                              print(f'Missing module docstring in: {file_path}')

              except SyntaxError:
                  pass

          # Check all Python files in nodupe directory
          for root, dirs, files in os.walk('nodupe'):
              for file in files:
                  if file.endswith('.py'):
                      check_docstrings(os.path.join(root, file))
          "

  security-scan:
    name: Security Scan
    needs: [test, lint, docs]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: AISBoM Security Scanner
        uses: docker://ghcr.io/aisecureworks/aisbom-scanner:latest
        with:
          args: scan --output-format=sarif --output-file=aisbom-results.sarif --severity-threshold=medium .

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: aisbom-results.sarif
        if: always()

  deploy:
    name: Deploy
    needs: [test, lint, docs, security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('output/ci_artifacts/requirements.txt', 'output/ci_artifacts/requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r output/ci_artifacts/requirements.txt
          pip install -r output/ci_artifacts/requirements-dev.txt

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            dist/
            build/
          key: ${{ runner.os }}-build-${{ hashFiles('pyproject.toml', 'output/ci_artifacts/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: Build package
        run: |
          python -m pip install --upgrade build
          python -m build --sdist --wheel

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            Automatic release created by GitHub Actions
            Changes: ${{ github.event.head_commit.message }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
