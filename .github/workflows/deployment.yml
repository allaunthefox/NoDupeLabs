name: Deployment

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  pypi-deploy:
    name: Deploy to PyPI
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.ref, 'tags')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel twine

    - name: Build package
      run: |
        python setup.py sdist bdist_wheel

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}  # github-actions: allow-secret-access

  docs-sphinx:
    name: Build Sphinx Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[docs]

      - name: Build Sphinx documentation
        run: |
          python scripts/build_docs.py --builder sphinx --clean

      - name: Upload Sphinx docs
        uses: actions/upload-artifact@v4
        with:
          name: sphinx-docs
          path: docs/_build/

  docs-mkdocs:
    name: Build MkDocs Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[mkdocs]

      - name: Build MkDocs documentation
        run: |
          python scripts/build_docs.py --builder mkdocs --clean

      - name: Upload MkDocs docs
        uses: actions/upload-artifact@v4
        with:
          name: mkdocs-docs
          path: site/

  docs-deploy:
    name: Deploy Documentation
    needs: [pypi-deploy, docs-sphinx, docs-mkdocs]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Sphinx docs
        uses: actions/download-artifact@v4
        with:
          name: sphinx-docs
          path: docs/_build/

      - name: Download MkDocs docs
        uses: actions/download-artifact@v4
        with:
          name: mkdocs-docs
          path: site/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
          force_orphan: true
